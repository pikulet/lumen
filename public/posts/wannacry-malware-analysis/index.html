<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.8bcb15280dd087872d46.css" id="gatsby-global-css">html{font-size:100}body{margin:0 0 0 calc(100vw - 100%);color:#222;line-height:1.625;font-size:1rem;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}body,h1,h2,h3,h4,h5,h6{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif}h1,h2,h3,h4,h5,h6{font-weight:600}h1{font-size:2.5rem;line-height:3.25rem;margin-top:6.5rem;margin-bottom:1.625rem}h2{font-size:1.6875rem;line-height:2.4375rem}h2,h3{margin-top:3.25rem;margin-bottom:.8125rem}h3{font-size:1.375rem;line-height:1.625rem}h4{font-size:1.2rem;margin-top:2.4375rem}h4,h5{line-height:1.625rem;margin-bottom:.8125rem}h5,h6{font-size:1rem;margin-top:4.0625rem}h6{line-height:1.625rem;margin-bottom:.8125rem}img{max-width:100%;margin:inherit auto}hr,img{border:0;display:block}hr{color:#222;height:1.625rem;margin:3.25rem auto;background-size:100% 26px;background-image:linear-gradient(180deg,transparent 1px,transparent 11px,#222 0,#222 15px,transparent 0,transparent 26px);width:6.25rem}a{color:#5d93ff;text-decoration:none}a:active,a:focus,a:hover{color:#f7a046}b,strong{font-weight:600}ul{list-style:square;margin-bottom:1.625rem}ul li{padding:0 .3125rem;margin-bottom:.625rem}p{line-height:1.625rem;margin-bottom:1.625rem}blockquote{padding:0;font-style:italic;text-align:center}figure{display:block;width:100%;height:auto}figcaption{line-height:1.21875rem;margin-top:.40625rem;color:#222;font-size:.875rem;font-style:italic;margin-bottom:0;text-align:center}.anchor{margin-left:-1.875rem!important;padding-right:.875rem!important}@media screen and (min-width:685px){figure.float-left,figure.float-right{max-width:19.375rem;padding:0 1.625rem}.float-right{float:right}.float-left{float:left}}code[class*=language-],pre[class*=language-]{color:#657b83;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{background:#073642}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:#fdf6e3}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#93a1a1}.token.punctuation{color:#586e75}.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#268bd2}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string,.token.url{color:#2aa198}.token.entity{color:#657b83;background:#eee8d5}.token.atrule,.token.attr-value,.token.keyword{color:#859900}.token.class-name,.token.function{color:#b58900}.token.important,.token.regex,.token.variable{color:#cb4b16}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.Author-module--author__photo--36xCH{display:inline-block;margin-bottom:0;border-radius:50%;background-clip:padding-box}.Author-module--author__title--2CaTb{font-size:1.125rem;font-weight:600;line-height:1.82813rem;margin:.8125rem 0}.Author-module--author__title-link--Yrism{color:#222}.Author-module--author__title-link--Yrism:focus,.Author-module--author__title-link--Yrism:hover{color:#222}.Author-module--author__subtitle--cAaEB{color:#888;line-height:1.625rem;margin-bottom:1.625rem}.Icon-module--icon--Gpyvw{display:inline-block;width:1em;height:1em;stroke-width:0;stroke:currentColor;fill:currentColor;font-style:normal;font-weight:400;speak:none;margin-right:.2em;text-align:center;font-variant:normal;text-transform:none;line-height:1em;margin-left:.2em;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.Contacts-module--contacts--1rGd1{margin-bottom:1.625rem}.Contacts-module--contacts__list--3OgdW{display:flex;flex-flow:row wrap;flex-grow:0;flex-shrink:0;list-style:none;padding:0;margin:.625rem -.1875rem;width:8.75rem}.Contacts-module--contacts__list-item--16p9q{padding:0;margin:.25rem;display:flex;align-content:center;align-items:center;justify-content:center;height:2.1875rem;width:2.1875rem;line-height:2.1875rem;border-radius:50%;text-align:center;border:1px solid #ebebeb}.Contacts-module--contacts__list-item-link--2MIDn{border:0;display:flex;color:#222}.Contacts-module--contacts__list-item-link--2MIDn:focus,.Contacts-module--contacts__list-item-link--2MIDn:hover{color:#5d93ff}.Copyright-module--copyright--1ariN{color:#b6b6b6;font-size:.875rem}.Menu-module--menu--Efbin{margin-bottom:1.625rem}.Menu-module--menu__list--31Zeo{list-style:none;padding:0;margin:0}.Menu-module--menu__list-item--1lJ6B{padding:0;margin:.625rem 0}.Menu-module--menu__list-item-link--10Ush{font-size:1rem;color:#222;font-weight:400;border:0}.Menu-module--menu__list-item-link--10Ush:focus,.Menu-module--menu__list-item-link--10Ush:hover{color:#5d93ff;border-bottom:1px solid #5d93ff}.Menu-module--menu__list-item-link--active--2CbUO{color:#222;border-bottom:1px solid #222}.Sidebar-module--sidebar--X4z2p{width:100%}.Sidebar-module--sidebar__inner--Jdc5s{position:relative;padding:1.5625rem 1.25rem 0}@media screen and (min-width:685px){.Sidebar-module--sidebar--X4z2p{width:calc(41.625% - 1.09375rem)}.Sidebar-module--sidebar--X4z2p:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Sidebar-module--sidebar--X4z2p:last-child{margin-right:0}.Sidebar-module--sidebar--X4z2p:nth-child(12n){margin-right:0;float:right}.Sidebar-module--sidebar--X4z2p:nth-child(12n+1){clear:both}.Sidebar-module--sidebar__inner--Jdc5s{padding:1.875rem 1.25rem 0}.Sidebar-module--sidebar__inner--Jdc5s:after{background:#e6e6e6;background:linear-gradient(180deg,#e6e6e6 0,#e6e6e6 48%,#fff);position:absolute;content:"";width:.0625rem;height:33.75rem;top:30px;right:-10px;bottom:0}}@media screen and (min-width:960px){.Sidebar-module--sidebar--X4z2p{width:calc(33.3% - 1.25rem)}.Sidebar-module--sidebar--X4z2p:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Sidebar-module--sidebar--X4z2p:last-child{margin-right:0}.Sidebar-module--sidebar--X4z2p:nth-child(3n){margin-right:0;float:right}.Sidebar-module--sidebar--X4z2p:nth-child(3n+1){clear:both}.Sidebar-module--sidebar__inner--Jdc5s{padding:2.5rem}}.Layout-module--layout--3Pyz6{max-width:66.875rem;margin-left:auto;margin-right:auto}.Layout-module--layout--3Pyz6:before{content:"";display:table}.Layout-module--layout--3Pyz6:after{content:"";display:table;clear:both}.Feed-module--feed__item--2D5rE{margin-bottom:2.03125rem}.Feed-module--feed__item--2D5rE:last-child{margin-bottom:.8125rem}.Feed-module--feed__item-title--3nigr{font-size:1.6875rem;line-height:2.4375rem;margin-top:0;margin-bottom:.8125rem}.Feed-module--feed__item-title-link--iFMRs{color:#222}.Feed-module--feed__item-title-link--iFMRs:focus,.Feed-module--feed__item-title-link--iFMRs:hover{color:#222;border-bottom:1px solid #222}.Feed-module--feed__item-description--1uO8e{font-size:1rem;line-height:1.625rem;margin-bottom:1.21875rem}.Feed-module--feed__item-meta-time--3t1fg{font-size:.875rem;color:#222;font-weight:600;text-transform:uppercase}.Feed-module--feed__item-meta-divider--N-Q0A{margin:0 .3125rem}.Feed-module--feed__item-meta-category-link--23f8F{font-size:.875rem;color:#f7a046;font-weight:600;text-transform:uppercase}.Feed-module--feed__item-meta-category-link--23f8F:focus,.Feed-module--feed__item-meta-category-link--23f8F:hover{color:#5d93ff}.Feed-module--feed__item-readmore--1u6bI{font-size:1rem;color:#5d93ff}.Feed-module--feed__item-readmore--1u6bI:focus,.Feed-module--feed__item-readmore--1u6bI:hover{color:#5d93ff;border-bottom:1px solid #5d93ff}.Page-module--page--2nMky{margin-bottom:3.25rem}.Page-module--page__inner--2M_vz{padding:1.5625rem 1.25rem}.Page-module--page__title--GPD8L{font-size:2.5rem;font-weight:600;line-height:3.25rem;margin-top:0;margin-bottom:2.35625rem}.Page-module--page__body--Ic6i6{font-size:1rem;line-height:1.625rem;margin:0 0 1.625rem}@media screen and (min-width:685px){.Page-module--page--2nMky{width:calc(58.275% - .78125rem)}.Page-module--page--2nMky:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Page-module--page--2nMky:last-child{margin-right:0}.Page-module--page--2nMky:nth-child(12n){margin-right:0;float:right}.Page-module--page--2nMky:nth-child(12n+1){clear:both}.Page-module--page__inner--2M_vz{padding:1.875rem 1.25rem}}@media screen and (min-width:960px){.Page-module--page--2nMky{width:calc(66.6% - .625rem)}.Page-module--page--2nMky:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Page-module--page--2nMky:last-child{margin-right:0}.Page-module--page--2nMky:nth-child(3n){margin-right:0;float:right}.Page-module--page--2nMky:nth-child(3n+1){clear:both}.Page-module--page__inner--2M_vz{padding:2.5rem 2.1875rem}}.Pagination-module--pagination--2H3nO{margin-top:3.25rem;display:flex}.Pagination-module--pagination__prev--bet5s{width:50%;text-align:left}.Pagination-module--pagination__prev-link--1Nzs6{color:#f7a046;font-size:1.625rem;font-weight:700}.Pagination-module--pagination__prev-link--1Nzs6:focus,.Pagination-module--pagination__prev-link--1Nzs6:hover{color:#5d93ff}.Pagination-module--pagination__prev-link--disable--Yklx9{pointer-events:none;color:#bbb}.Pagination-module--pagination__next--3hFiN{width:50%;text-align:right}.Pagination-module--pagination__next-link--3FUtA{color:#f7a046;font-size:1.625rem;font-weight:700}.Pagination-module--pagination__next-link--3FUtA:focus,.Pagination-module--pagination__next-link--3FUtA:hover{color:#5d93ff}.Pagination-module--pagination__next-link--disable--30UwZ{pointer-events:none;color:#bbb}.Author-module--author--2Yefr{border-top:1px solid #e6e6e6;max-width:40rem;padding-top:1.25rem;line-height:1.625rem;margin-top:1.625rem;margin-bottom:3.25rem}.Author-module--author__bio-twitter--n-O9n{display:block;text-decoration:underline}@media screen and (min-width:685px){.Author-module--author--2Yefr{margin-left:auto;margin-right:auto}}.Content-module--content--3p512{max-width:59.0625rem;padding:0 .9375rem;margin:0 auto}.Content-module--content__title--2BDW9{font-size:2rem;max-width:40rem;font-weight:600;text-align:center;line-height:2.68125rem;margin:1.625rem auto 0}.Content-module--content__body--2TrQ- figure{margin-bottom:1.625rem}.Content-module--content__body--2TrQ- figure blockquote{font-style:italic;text-align:center;margin-top:0;padding:1.625rem 0}.Content-module--content__body--2TrQ- figure blockquote p{max-width:40rem;font-size:1.6817rem;margin-top:0;margin-bottom:1.625rem;line-height:2.4375rem}.Content-module--content__body--2TrQ- a{text-decoration:underline}.Content-module--content__body--2TrQ- *{max-width:40rem;margin-left:auto;margin-right:auto}.Content-module--content__body--2TrQ- img{max-width:100%}@media screen and (min-width:960px){.Content-module--content--3p512{padding:0}.Content-module--content__title--2BDW9{font-size:3rem;line-height:3.65625rem;margin-top:3.65625rem;margin-bottom:2.4375rem}.Content-module--content__body--2TrQ-,.Content-module--content__body--2TrQ- p{font-size:1.125rem;line-height:1.82813rem;margin-bottom:1.82813rem}}.Meta-module--meta__date--29eD7{font-style:italic}.Tags-module--tags--1L_ct{margin-bottom:.8125rem}.Tags-module--tags__list--91FqN{list-style:none;margin:0 -.625rem;padding:0}.Tags-module--tags__list-item--1M30P{display:inline-block;margin:.625rem .3125rem}.Tags-module--tags__list-item-link--3SL_8{display:inline-block;height:2.1875rem;padding:0 1.5rem;line-height:2.1875rem;border:1px solid #e6e6e6;text-decoration:none;border-radius:1.25rem;color:#222}.Tags-module--tags__list-item-link--3SL_8:focus,.Tags-module--tags__list-item-link--3SL_8:hover{color:#5d93ff}.Post-module--post__comments--25y6I,.Post-module--post__footer--3WzWU{max-width:40rem;margin:0 auto;padding:0 .9375rem}.Post-module--post__home-button--16Kl0{display:block;max-width:5.625rem;height:2.1875rem;padding:0 1.5rem;line-height:2.1875rem;text-align:center;color:#222;border:1px solid #e6e6e6;border-radius:1.25rem;font-size:1rem;font-weight:400;margin-left:auto;margin-right:auto;margin-top:1.625rem}.Post-module--post__home-button--16Kl0:focus,.Post-module--post__home-button--16Kl0:hover{color:#5d93ff}@media screen and (min-width:960px){.Post-module--post__comments--25y6I,.Post-module--post__footer--3WzWU{padding:0}.Post-module--post__home-button--16Kl0{position:fixed;max-width:auto;margin:0;top:30px;left:30px}}</style><meta name="generator" content="Gatsby 2.29.3"/><link rel="alternate" type="application/rss+xml" title="Joyce Yeo" href="/rss.xml"/><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><script async="" src="https://www.googletagmanager.com/gtag/js?id="></script><script>
      
      
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){window.dataLayer && window.dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', '', {"send_page_view":false});
      }
      </script><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link rel="icon" href="/favicon-32x32.png?v=2901374841874cd528f6c23cefb75e3e" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><meta name="theme-color" content="#F7A046"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=2901374841874cd528f6c23cefb75e3e"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=2901374841874cd528f6c23cefb75e3e"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=2901374841874cd528f6c23cefb75e3e"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=2901374841874cd528f6c23cefb75e3e"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=2901374841874cd528f6c23cefb75e3e"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=2901374841874cd528f6c23cefb75e3e"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=2901374841874cd528f6c23cefb75e3e"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=2901374841874cd528f6c23cefb75e3e"/><title data-react-helmet="true">The killswitch in Wannacry - Joyce Yeo</title><meta data-react-helmet="true" name="description" content="Basic analysis techniques, and an example of the killswitch"/><meta data-react-helmet="true" property="og:site_name" content="The killswitch in Wannacry - Joyce Yeo"/><meta data-react-helmet="true" property="og:image" content="https://joyceyeo.netlify.app/photo.jpg"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:title" content="The killswitch in Wannacry - Joyce Yeo"/><meta data-react-helmet="true" name="twitter:description" content="Basic analysis techniques, and an example of the killswitch"/><meta data-react-helmet="true" name="twitter:image" content="https://joyceyeo.netlify.app/photo.jpg"/><link as="script" rel="preload" href="/webpack-runtime-86b7e573ecc0f63b86e5.js"/><link as="script" rel="preload" href="/framework-f0fa8831b6d960814d9c.js"/><link as="script" rel="preload" href="/532a2f07-5d61e092ba8c45c5c11a.js"/><link as="script" rel="preload" href="/dc6a8720040df98778fe970bf6c000a41750d3ae-d743a9af41120ad88de2.js"/><link as="script" rel="preload" href="/app-c3dc184b6a1bdd830d99.js"/><link as="script" rel="preload" href="/styles-407fe62976dc5310c43e.js"/><link as="script" rel="preload" href="/cd95ea5cbd2c605f26db819f07999610c9ff4310-73792d2496c1cedff2b5.js"/><link as="script" rel="preload" href="/component---src-templates-post-template-js-590414f8b47d5d869713.js"/><link as="fetch" rel="preload" href="/page-data/posts/wannacry-malware-analysis/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/251939775.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/3439816877.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/401334301.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="Layout-module--layout--3Pyz6"><div><a class="Post-module--post__home-button--16Kl0" href="/">All Articles</a><div><div class="Content-module--content--3p512"><h1 class="Content-module--content__title--2BDW9">The killswitch in Wannacry</h1><div class="Content-module--content__body--2TrQ-"><p><a href="https://en.wikipedia.org/wiki/WannaCry_ransomware_attack" target="_blank" rel="nofollow noopener noreferrer">Wannacry</a> is a pretty well-known ransomware, known to have locked away <strong>millions</strong> of precious photographs and important documents. The ransomware will then request for a certain amount of bitcoin before decrypting your personal files. This post shares about the killswitch mechanism in Wannacry. This analysis project was a collaboration between Jonathan Cheng and me in Oct - Dec 2020.</p>
<h2 id="basic-analysis-tools" style="position:relative;"><a href="#basic-analysis-tools" aria-label="basic analysis tools permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Basic Analysis Tools</h2>
<p>When you get the wannacry binary, it’s not going to come in a file named “WANNACRY_MALWARE.EXE”. Wannacry makes use of obscure naming patterns in the Windows registry, blending itself in with a name like <em>09a46b3e1be080745a6d8d88d6b5bd351b1c7586ae0dc94d0c238ee36421cafa.bin</em>. So, given an unknown file the first thing to do is to place it in a sandboxed environment like a Virtual Machine, so that the repercussions will not translate to your personal files. Thankfully, there are multiple malware databases like <a href="https://www.virustotal.com" target="_blank" rel="nofollow noopener noreferrer">VirusTotal</a>. You can simply upload a file to VirusTotal, and it can compare the entire file hash to known malware hashes, alerting you of any danger. </p>
<p>Now, at this point you might think “Oh, perhaps changing some compile options and strings can change the entire binary’s hash”. Well, VirusTotal is intelligent enough to compare not just the hash, but also certain code sections. It is especially alert to obfuscating code sections commonly used by malware, such as IsDebuggerPresent, which prevents a malware from being debugged easily. If you’re interested in such obfuscation techniques, I’ve created a simple repository of <a href="https://github.com/pikulet/anti-debugging" target="_blank" rel="nofollow noopener noreferrer">techniques that I previously studied</a>.</p>
<p>Anyhow, it’s not particularly interesting for reverse engineers to look at VirusTotal’s response. Yes we know it’s a malware, but how does it work? We then take a snapshot of it’s key information using PEStudio, ResourceHacker and HashCalc. These tools basically break down the Portable Executable (PE) format into easily-comprehensible sections and resources that will help us understand how the instruction pointer changes during execution. Again, nothing interesting here but this is basic information used when analysts share information with each other. This is because in reality, there are multiple versions of Wannacry being circulated and we want to pinpoint an exact binary type when discussing its behaviour. </p>
<p>Next, would be actually analysing its behaviour. It would be ideal if we could map out its entire control flow, but doing that from a binary is extremely difficult, even with the help of <a href="https://www.hex-rays.com/ida-pro/" target="_blank" rel="nofollow noopener noreferrer">IDAPro</a> or <a href="https://ghidra-sre.org/" target="_blank" rel="nofollow noopener noreferrer">Ghidra</a>, which help to convert the binary code to very primitive source code. </p>
<h2 id="killswitch" style="position:relative;"><a href="#killswitch" aria-label="killswitch permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Killswitch</h2>
<p>I was surprised when I first learnt about the existence of a killswitch mechanism in Wannacry. This mechanism, when activated, is able to neutralise future instances of Wannacry. And it’s written by the Wannacry authors themselves. I’ll first talk about how the killswitch manifests, and then discuss a <em>little</em> of the question behind all our minds now - <strong>why is there a killswitch</strong>?</p>
<h3 id="locating-the-killswitch-in-the-binary" style="position:relative;"><a href="#locating-the-killswitch-in-the-binary" aria-label="locating the killswitch in the binary permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Locating the killswitch in the binary</h3>
<p>We always check through all the strings in the binary because strings are the most human-readable entities. We found that Wannacry attempts to visit a particular URL.</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/6ab7d5508b71e77074938990be4255ad/7f15f/killswitch-2.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 31.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABQElEQVQY03WQSXOCQBCF/f9/J1W5BK2K4iGkjBU1JIqJC25sAsIwCwMvzcRrZuqr14eZ1/261+LvaEI2rdGsYLAsx+A4CyRZjjRlSPIMDd3uBNEVvNaoqVaEUTLrHaMU3j5EfBPmQaVq5CXDbOFh+r6E+7mG6/pYfx+w9X2cLxds9yf87E4ouCCk4VZxcN2i57zN8fBoYWS/YO15iKlzRE2UEtBaoqKHBU3MRWVqxjqtIAQ3amrOEYQhrkyg97FcYTQaot9/gvM6wW4X43hMEcQJWCUoKjfUXby6hupQClJKSCWNaq2R0lqCznC29GDbY4xtG/MZ7SspkNG+NpsQ5yhCkMY0lUCjaXv0Ud/pzOu7eds0SPMch85w+rXC4HkIazDA62SKhbvF4RTjmhUoKQ6jaCVFKqv/YUJQ8xh+KfALnkXDqt8FOFgAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
        <source
          srcset="/static/6ab7d5508b71e77074938990be4255ad/8ac56/killswitch-2.webp 240w,
/static/6ab7d5508b71e77074938990be4255ad/d3be9/killswitch-2.webp 480w,
/static/6ab7d5508b71e77074938990be4255ad/e46b2/killswitch-2.webp 960w,
/static/6ab7d5508b71e77074938990be4255ad/f992d/killswitch-2.webp 1440w,
/static/6ab7d5508b71e77074938990be4255ad/e0a0d/killswitch-2.webp 1530w"
          sizes="(max-width: 960px) 100vw, 960px"
          type="image/webp"
        />
        <source
          srcset="/static/6ab7d5508b71e77074938990be4255ad/8ff5a/killswitch-2.png 240w,
/static/6ab7d5508b71e77074938990be4255ad/e85cb/killswitch-2.png 480w,
/static/6ab7d5508b71e77074938990be4255ad/d9199/killswitch-2.png 960w,
/static/6ab7d5508b71e77074938990be4255ad/07a9c/killswitch-2.png 1440w,
/static/6ab7d5508b71e77074938990be4255ad/7f15f/killswitch-2.png 1530w"
          sizes="(max-width: 960px) 100vw, 960px"
          type="image/png"
        />
        <img
          class="gatsby-resp-image-image"
          src="/static/6ab7d5508b71e77074938990be4255ad/d9199/killswitch-2.png"
          alt="killswitch-url"
          title="killswitch-url"
          loading="lazy"
          style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        />
      </picture>
  </a>
    </span></p>
<p>The result of visiting the domain is tested. If the domain is alive and the malware can connect to the site, the return value to <code class="language-text">InternetOpenUrl</code> (stored in the <code class="language-text">eax</code> and then <code class="language-text">edi</code> registers) is 0. Then, the <code class="language-text">jnz</code> jump is taken.</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/f2320075f13ff2ca9df03015e24d7a5d/8cdda/killswitch-1.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 40%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABmUlEQVQoz1WSj26aUBSHff836AP0BWqyZFum4MS61bTaZBuWIRpFoqj8t+gFvp1rk9ZBvvwON/Ddw4HWzU2b21uDT19GTKceQbDG9332+z1ZlpCmsaRwlXEsRFfEH7Tu2p+5a3+l881kMBjwMBoxHo9FHFAUR5FkIs3I8pw0l1qusyInvyKTdX2fpmVZ3+n1DEzToGt0sSyLp6dHVqsQ161YrxXzucLzFEu3ZruqqYoGTkDJW14dLdM06Xa76Oz1epcutdDzfBnBTro8czgcceyQzH4lsQuUq1DTM5Vs0qyq/4VaYhjGu/D+fshkMpbufF5ettR1TRTlIl8TJTmbXfL+cCNn+qoIdid28emSLS3rdDqXLnXd7/cZjX5i2wsRhlRVLcMumLkb4qQgCY+oxQm1PFHOXtn/KggeMsLHjPWP7EOoU2NZA56fJ3izlQg3KFXJRymlw5DlMsJ1Dqi04Zw1KKE5yjyFJpeU2bZ0R/pVdWqGw+FF6Dhz/joBZVnKL5TI2kKEW9kkwnZi/kzfmF7qhN92zNJP+Qen3UdRvjVOsAAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
        <source
          srcset="/static/f2320075f13ff2ca9df03015e24d7a5d/8ac56/killswitch-1.webp 240w,
/static/f2320075f13ff2ca9df03015e24d7a5d/d3be9/killswitch-1.webp 480w,
/static/f2320075f13ff2ca9df03015e24d7a5d/e46b2/killswitch-1.webp 960w,
/static/f2320075f13ff2ca9df03015e24d7a5d/2768a/killswitch-1.webp 1168w"
          sizes="(max-width: 960px) 100vw, 960px"
          type="image/webp"
        />
        <source
          srcset="/static/f2320075f13ff2ca9df03015e24d7a5d/8ff5a/killswitch-1.png 240w,
/static/f2320075f13ff2ca9df03015e24d7a5d/e85cb/killswitch-1.png 480w,
/static/f2320075f13ff2ca9df03015e24d7a5d/d9199/killswitch-1.png 960w,
/static/f2320075f13ff2ca9df03015e24d7a5d/8cdda/killswitch-1.png 1168w"
          sizes="(max-width: 960px) 100vw, 960px"
          type="image/png"
        />
        <img
          class="gatsby-resp-image-image"
          src="/static/f2320075f13ff2ca9df03015e24d7a5d/d9199/killswitch-1.png"
          alt="killswitch-loop"
          title="killswitch-loop"
          loading="lazy"
          style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        />
      </picture>
  </a>
    </span> </p>
<p>When the URL can be visited, the malicious payload is not executed. Currently, this URL has been <strong>sinkholed</strong> by <a href="https://techcrunch.com/2019/07/08/the-wannacry-sinkhole/" target="_blank" rel="nofollow noopener noreferrer">KryptosLogic</a>. This means that any attempt to connect to that domain will be falsely routed to a site put up by KryptosLogic. In effect, it means that the malware trying to access the domain will be successful, preventing millions of malware instances from executing the payload. In the present state of affairs, many computers have already been infected by Wannacry, saved by the lifeline of being able to reach the killswitch sinkhole. </p>
<p>Thinking ahead, how long can we rely on the goodwill of a company to keep that sinkhole active? Also, it is very simple for the malware authors to simply compile new binaries with different killswitches. How can we effectively manage a new barrage of Wannacry instances?</p>
<h3 id="why-did-the-authors-write-a-killswitch" style="position:relative;"><a href="#why-did-the-authors-write-a-killswitch" aria-label="why did the authors write a killswitch permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Why did the authors write a killswitch?</h3>
<p>There are <a href="https://www.quora.com/Why-would-WannaCry-have-a-built-in-kill-switch-based-on-a-web-domain" target="_blank" rel="nofollow noopener noreferrer">many competing theories</a> behind this, and the reality is probably a combination of many reasons. Seriously, you can dive into a rabbithole reading up about possible reasons for a killswitch, including</p>
<ul>
<li>Sandbox evasion. Most user machines would not have been able to visit the non-existent website, whereas virtual machines that emulate a network would pass that check. Then, the malware would not be able to run in VMs. I don’t find this explanation likely because there are multiple more effective VM-detection techniques rather than a killswitch that would nullify all their efforts.</li>
<li>Used in development, to prevent the worm from spreading to their own machines during the testing process. Also unlikely that someone would forget to release a debugging code for two whole years after the killswitch was discovered.</li>
<li>Failsafe. The malware could have unintended consequences like crashing the entire host machines instead of merely encrypting the files, giving the hackers no real benefits.</li>
</ul>
<h2 id="remarks" style="position:relative;"><a href="#remarks" aria-label="remarks permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Remarks</h2>
<p>I warmly invite you to dip your hands into taking apart Wannacry, and share anything interesting with me. Our full report is found <a href="/wannacry-report.pdf">here</a>.</p></div></div></div><div class="Post-module--post__footer--3WzWU"><div><p class="Meta-module--meta__date--29eD7">Published <!-- -->Aug 30, 2021</p></div><div class="Tags-module--tags--1L_ct"><ul class="Tags-module--tags__list--91FqN"><li class="Tags-module--tags__list-item--1M30P"><a class="Tags-module--tags__list-item-link--3SL_8" href="/tag/wannacry/">wannacry</a></li><li class="Tags-module--tags__list-item--1M30P"><a class="Tags-module--tags__list-item-link--3SL_8" href="/tag/malware/">malware</a></li><li class="Tags-module--tags__list-item--1M30P"><a class="Tags-module--tags__list-item-link--3SL_8" href="/tag/binary-analysis/">binary analysis</a></li></ul></div><div class="Author-module--author--2Yefr"><p>All up for puzzles and games. Well-versed in Python, Golang. <a href="https://www.twitter.com/pikulet" rel="noopener noreferrer" target="_blank">Find me on GitHub</a></p></div></div><div class="Post-module--post__comments--25y6I"></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/posts/wannacry-malware-analysis";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-9f4f178102f0a56754ae.js"],"app":["/app-c3dc184b6a1bdd830d99.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-fd4fb51a6fac1c18bdde.js"],"component---src-templates-categories-list-template-js":["/component---src-templates-categories-list-template-js-2181ec47d28e5c35d3e9.js"],"component---src-templates-category-template-js":["/component---src-templates-category-template-js-80d7889eeb6395877420.js"],"component---src-templates-index-template-js":["/component---src-templates-index-template-js-ca748dd912acdce40443.js"],"component---src-templates-not-found-template-js":["/component---src-templates-not-found-template-js-658f4507169e2836a377.js"],"component---src-templates-page-template-js":["/component---src-templates-page-template-js-3f44b90abaee160142f0.js"],"component---src-templates-post-template-js":["/component---src-templates-post-template-js-590414f8b47d5d869713.js"],"component---src-templates-tag-template-js":["/component---src-templates-tag-template-js-4ec669dfbc1ce8819e34.js"],"component---src-templates-tags-list-template-js":["/component---src-templates-tags-list-template-js-2d7007993fc2bf0f9caf.js"]};/*]]>*/</script><script src="/polyfill-9f4f178102f0a56754ae.js" nomodule=""></script><script src="/component---src-templates-post-template-js-590414f8b47d5d869713.js" async=""></script><script src="/cd95ea5cbd2c605f26db819f07999610c9ff4310-73792d2496c1cedff2b5.js" async=""></script><script src="/styles-407fe62976dc5310c43e.js" async=""></script><script src="/app-c3dc184b6a1bdd830d99.js" async=""></script><script src="/dc6a8720040df98778fe970bf6c000a41750d3ae-d743a9af41120ad88de2.js" async=""></script><script src="/532a2f07-5d61e092ba8c45c5c11a.js" async=""></script><script src="/framework-f0fa8831b6d960814d9c.js" async=""></script><script src="/webpack-runtime-86b7e573ecc0f63b86e5.js" async=""></script></body></html>